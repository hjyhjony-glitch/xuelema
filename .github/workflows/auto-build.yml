name: Auto-Build with Self-Healing

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      retry_count:
        description: 'Retry count'
        required: false
        default: '0'

# é…ç½®GitHub Actionsæƒé™
permissions:
  contents: write  # å…è®¸self-healæäº¤ä¿®å¤ä»£ç 
  actions: read   # å…è®¸è¯»å–æ„å»ºçŠ¶æ€
  checks: write   # å…è®¸æ›´æ–°æ£€æŸ¥çŠ¶æ€

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.analyze.outputs.success }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Install git
      run: |
        which git || apt-get update && apt-get install -y git
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Generate localization files
      run: flutter gen-l10n
    
    - name: Run flutter analyze
      id: analyze
      run: |
        result=$(flutter analyze 2>&1)
        echo "$result" > analyze_result.txt
        if echo "$result" | grep -q "error:"; then
          echo "success=false" >> $GITHUB_OUTPUT
          echo "=== Flutter Analyze Errors ===" >> $GITHUB_STEP_SUMMARY
          echo "$result" | grep "error:" >> $GITHUB_STEP_SUMMARY
          exit 1
        else
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… No analyze errors found" >> $GITHUB_STEP_SUMMARY
        fi

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Install git
      run: |
        which git || apt-get update && apt-get install -y git
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Generate localization files
      run: flutter gen-l10n
    
    - name: Run tests
      run: flutter test --coverage

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Install git
      run: |
        which git || apt-get update && apt-get install -y git
    
    - name: Clean build
      run: flutter clean
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Generate localization files
      run: flutter gen-l10n
    
    - name: Build APK
      id: build
      run: |
        result=$(flutter build apk --debug 2>&1)
        echo "$result" > build_result.txt
        echo "$result"
        if [ $? -ne 0 ]; then
          exit 1
        fi
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: build/app/outputs/flutter-apk/app-debug.apk

  self-heal:
    name: Self-Healing (Auto-Retry)
    runs-on: ubuntu-latest
    needs: build-android
    if: ${{ failure() && github.event_name == 'push' && github.event.inputs.retry_count == '0' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ä¾¿gitæ“ä½œ
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Install git
      if: runner.os != 'Windows'  # Windows runnerè‡ªå¸¦git
      run: |
        which git || apt-get update && apt-get install -y git
    
    - name: Analyze build failure
      id: analyze
      run: |
        echo "=== Build Failure Analysis ==="
        echo "Checking common issues..."
        
        # è¯»å–ä¹‹å‰çš„æ„å»ºæ—¥å¿—
        if [ -f build_result.txt ]; then
          echo "Build result:"
          cat build_result.txt
        fi
        
        # æ£€æŸ¥l10nå›½é™…åŒ–é”™è¯¯
        if grep -r "app_localizations" lib --include="*.dart" | grep -q "import"; then
          echo "âš ï¸ Found l10n import errors"
          fixed=true
        fi
        
        # æ£€æŸ¥ç¼ºå°‘çš„import
        if grep -q "Undefined class\|Undefined name" build_result.txt; then
          echo "âš ï¸ Found missing classes or imports"
          fixed=true
        fi
        
        # æ£€æŸ¥ä¾èµ–é—®é¢˜
        if grep -q "The current Dart SDK version\|depends on" build_result.txt; then
          echo "âš ï¸ Found dependency version issues"
          fixed=true
        fi
        
        # è¾“å‡ºä¿®å¤çŠ¶æ€
        if [ "$fixed" == "true" ]; then
          echo "Issues found. Auto-fix will be applied."
        else
          echo "No auto-fixable issues found. Manual intervention required."
        fi
    
    - name: Try auto-fix common issues
      id: fix
      run: |
        # æ¸…ç†buildç›®å½•
        flutter clean
        
        # é‡æ–°è·å–ä¾èµ–
        flutter pub get
        
        echo "fixed=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push auto-fixes
      if: steps.fix.outputs.fixed == 'true'
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git commit -m "auto-fix: heal common build issues" || echo "No changes to commit"
        git push origin ${{ github.ref }} || echo "Push failed - may need permissions"
    
    - name: Trigger retry workflow
      if: steps.fix.outputs.fixed == 'true'
      run: |
        echo "Auto-fix applied. New build will be triggered by the commit above."
        # ç­‰å¾…ä¸€å°æ®µæ—¶é—´
        sleep 5

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build-android, self-heal]
    if: always()
    
    steps:
    - name: Check build status
      id: status
      run: |
        if [ "${{ needs.build-android.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… Build completed successfully!"
          echo "APK: build/app/outputs/flutter-apk/app-debug.apk"
        elif [ "${{ needs.self-heal.outputs.fixed }}" == "true" ]; then
          echo "status=healed" >> $GITHUB_OUTPUT
          echo "ğŸ”§ Auto-fix applied. Check new build."
        else
          echo "status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Build failed. Manual intervention required."
        fi

    - name: Send failure notification to Feishu
      if: needs.build-android.result == 'failure'
      run: |
        if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âš ï¸ **GitHub Actions æ„å»ºå¤±è´¥**\n\né¡¹ç›®: xuelema\nåˆ†æ”¯: ${{ github.ref }}\næ—¶é—´: ${{ github.event.head_commit.timestamp }}\n\nğŸ”— [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
              }
            }' \
            "${{ secrets.FEISHU_WEBHOOK_URL }}"
        else
          echo "FEISHU_WEBHOOK_URL not configured, skipping notification"
        fi

    - name: Send success notification to Feishu
      if: needs.build-android.result == 'success'
      run: |
        if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âœ… **GitHub Actions æ„å»ºæˆåŠŸ**\n\né¡¹ç›®: xuelema\nåˆ†æ”¯: ${{ github.ref }}\næ—¶é—´: ${{ github.event.head_commit.timestamp }}\n\nAPK: build/app/outputs/flutter-apk/app-debug.apk"
              }
            }' \
            "${{ secrets.FEISHU_WEBHOOK_URL }}"
        else
          echo "FEISHU_WEBHOOK_URL not configured, skipping notification"
        fi

  report:
    name: Build Report
    runs-on: ubuntu-latest
    needs: notify
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "=== Build Summary ==="
        echo "Build: ${{ needs.build-android.result }}"
        echo "Self-Heal: ${{ needs.self-heal.result || 'skipped' }}"
        echo "Notify: ${{ needs.notify.result }}"
