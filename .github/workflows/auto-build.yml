name: Auto-Build with Self-Healing

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      retry_count:
        description: 'Retry count'
        required: false
        default: '0'

# é…ç½®GitHub Actionsæƒé™
permissions:
  contents: write  # å…è®¸self-healæäº¤ä¿®å¤ä»£ç 
  actions: read   # å…è®¸è¯»å–æ„å»ºçŠ¶æ€
  checks: write   # å…è®¸æ›´æ–°æ£€æŸ¥çŠ¶æ€

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    outputs:
      success: ${{ steps.analyze.outputs.success }}
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run flutter analyze
      id: analyze
      run: |
        result=$(flutter analyze 2>&1)
        echo "$result" > analyze_result.txt
        mkdir -p error-logs
        echo "$result" > error-logs/analyze_full.log
        
        if echo "$result" | grep -q "error:"; then
          echo "success=false" >> $GITHUB_OUTPUT
          echo "$result" | grep "error:" > error-logs/analyze_errors.txt
          echo "=== Flutter Analyze Errors ==="
          cat error-logs/analyze_errors.txt
          exit 1
        else
          echo "success=true" >> $GITHUB_OUTPUT
          echo "âœ… No analyze errors found"
        fi
    
    # âœ… ä¿®å¤: ç¡®ä¿ analyze å¤±è´¥æ—¶ä¸Šä¼  artifact
    - name: Upload analyze errors
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: analyze-errors
        path: error-logs/

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: analyze
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Run tests
      run: flutter test --coverage

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    - name: Clean build
      run: flutter clean
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build APK
      id: build
      run: |
        result=$(flutter build apk --debug 2>&1)
        echo "$result" > build_result.txt
        echo "$result"
        if [ $? -ne 0 ]; then
          exit 1
        fi
    
    - name: Upload build result
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: build-result
        path: build_result.txt
        retention-days: 1
    
    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: build/app/outputs/flutter-apk/app-debug.apk

  self-heal:
    name: Self-Healing (Auto-Retry)
    runs-on: ubuntu-latest
    needs: build-android
    # âœ… ä¿®å¤: ä½¿ç”¨æ­£ç¡®çš„ä¸Šä¸‹æ–‡è¯­æ³•
    if: ${{ failure() && github.event_name == 'push' && github.actor != 'github-actions[bot]' && github.event.inputs.retry_count != '1' }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ github.ref }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.4'
        channel: 'stable'
    
    # âœ… ä¿®å¤: ä¸‹è½½æ­£ç¡®çš„ artifact åç§°
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-result  # âœ… ä½¿ç”¨å®é™…å­˜åœ¨çš„ artifact åç§°
        path: build-logs
      continue-on-error: true
    
    - name: Analyze build failure
      id: analyze
      run: |
        echo "=== Build Failure Analysis ==="
        echo "Checking common issues..."
        
        # è¯»å–ä¹‹å‰çš„æ„å»ºæ—¥å¿—ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
        if [ -f build-logs/build_result.txt ]; then
          echo "=== Build Result ==="
          cat build-logs/build_result.txt
        fi
        
        # è¾“å‡ºä¿®å¤çŠ¶æ€
        echo "fixed=false" >> $GITHUB_OUTPUT
        
        # æ£€æŸ¥l10nå›½é™…åŒ–é”™è¯¯
        if grep -r "app_localizations" lib --include="*.dart" | grep -q "import"; then
          echo "âš ï¸ Found l10n import errors"
          echo "fixed=true" >> $GITHUB_OUTPUT
        fi
        
        # æ£€æŸ¥ç¼ºå°‘çš„import
        if grep -q "Undefined class\|Undefined name" build-logs/build_result.txt 2>/dev/null; then
          echo "âš ï¸ Found missing classes or imports"
          echo "fixed=true" >> $GITHUB_OUTPUT
        fi
        
        # æ£€æŸ¥ä¾èµ–é—®é¢˜
        if grep -q "The current Dart SDK version\|depends on" build-logs/build_result.txt 2>/dev/null; then
          echo "âš ï¸ Found dependency version issues"
          echo "fixed=true" >> $GITHUB_OUTPUT
        fi
        
        # æ£€æŸ¥æ–‡ä»¶è·¯å¾„é—®é¢˜ï¼ˆWindowsè·¯å¾„é—®é¢˜ï¼‰
        if grep -q "E:\\\\xueliao" build-logs/build_result.txt 2>/dev/null; then
          echo "âš ï¸ Found Windows path issues in build logs"
          echo "fixed=true" >> $GITHUB_OUTPUT
        fi
        
        # æ£€æŸ¥Flutterç‰ˆæœ¬é—®é¢˜
        if grep -q "No pubspec.yaml\|pubspec.lock" build-logs/build_result.txt 2>/dev/null; then
          echo "âš ï¸ Found pubspec issues"
          echo "fixed=true" >> $GITHUB_OUTPUT
        fi
        
        FIXED=$(cat $GITHUB_OUTPUT | grep "fixed=" | cut -d= -f2)
        if [ "$FIXED" == "true" ]; then
          echo "Issues found. Auto-fix will be applied."
        else
          echo "No auto-fixable issues found. Manual intervention required."
        fi
    
    - name: Try auto-fix common issues
      id: fix
      run: |
        # æ¸…ç†buildç›®å½•
        flutter clean
        
        # é‡æ–°è·å–ä¾èµ–
        flutter pub get
        
        echo "fixed=true" >> $GITHUB_OUTPUT
    
    - name: Commit and push auto-fixes
      if: steps.fix.outputs.fixed == 'true'
      run: |
        # ä¿®å¤: æ·»åŠ tokené…ç½®
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add -A
        git commit -m "auto-fix: heal common build issues" || echo "No changes to commit"
        # ä¿®å¤: ä½¿ç”¨tokenè¿›è¡Œpush
        git push origin ${{ github.ref }} || echo "Push failed - may need permissions"
    
    - name: Trigger retry workflow
      if: steps.fix.outputs.fixed == 'true'
      run: |
        echo "Auto-fix applied. New build will be triggered by the commit above."
        echo "retry_count=1" >> $GITHUB_OUTPUT

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [analyze]
    if: always()
    
    steps:
    # âœ… ä¿®å¤: æ­£ç¡®ä¸‹è½½ analyze-errors artifact
    - name: Download analyze errors
      if: needs.analyze.result == 'failure'
      uses: actions/download-artifact@v4
      with:
        name: analyze-errors
        path: error-logs
      continue-on-error: true
    
    - name: Read error details
      id: errors
      if: needs.analyze.result == 'failure'
      run: |
        if [ -f error-logs/analyze_errors.txt ]; then
          echo "errors=$(cat error-logs/analyze_errors.txt | head -20 | tr '\n' ' ' | sed 's/"/\\"/g' | cut -c1-500)" >> $GITHUB_OUTPUT
        else
          echo "errors=Unknown error - artifact may not exist" >> $GITHUB_OUTPUT
        fi
    
    - name: Check build status
      id: status
      run: |
        ANALYZE_STATUS="${{ needs.analyze.result }}"
        
        if [ "$ANALYZE_STATUS" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
        else
          echo "status=failed" >> $GITHUB_OUTPUT
        fi
    
    - name: Send failure notification to Feishu
      if: needs.analyze.result == 'failure'
      run: |
        ERRORS=""
        if [ -f error-logs/analyze_errors.txt ]; then
          ERRORS=$(cat error-logs/analyze_errors.txt | grep "error:" | head -5 | tr '\n' ' ')
        fi
        
        if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
          curl -X POST -H "Content-Type: application/json" \
            -d "{
              \"msg_type\": \"text\",
              \"content\": {
                \"text\": \"âš ï¸ **GitHub Actions æ„å»ºå¤±è´¥**\\n\\né¡¹ç›®: xuelema\\nåˆ†æ”¯: ${{ github.ref }}\\n\\nğŸ” **é”™è¯¯ä¿¡æ¯**:\\n$ERRORS\\n\\nğŸ”— [æŸ¥çœ‹è¯¦æƒ…](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\"
              }
            }" \
            "${{ secrets.FEISHU_WEBHOOK_URL }}" || echo "Failed to send Feishu notification"
        else
          echo "FEISHU_WEBHOOK_URL not configured"
        fi
    
    - name: Send success notification to Feishu
      if: needs.analyze.result == 'success'
      run: |
        if [ -n "${{ secrets.FEISHU_WEBHOOK_URL }}" ]; then
          curl -X POST -H "Content-Type: application/json" \
            -d '{
              "msg_type": "text",
              "content": {
                "text": "âœ… **GitHub Actions ä»£ç åˆ†æé€šè¿‡**\\n\\né¡¹ç›®: xuelema\\nåˆ†æ”¯: ${{ github.ref }}\\n\\nä»£ç åˆ†æé€šè¿‡ï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥æ„å»ºã€‚"
              }
            }' \
            "${{ secrets.FEISHU_WEBHOOK_URL }}" || echo "Failed to send Feishu notification"
        else
          echo "FEISHU_WEBHOOK_URL not configured"
        fi

  report:
    name: Build Report
    runs-on: ubuntu-latest
    needs: notify
    if: always()
    
    steps:
    - name: Generate summary
      run: |
        echo "=== Build Summary ==="
        echo "Build: ${{ needs.build-android.result }}"
        echo "Self-Heal: ${{ needs.self-heal.result || 'skipped' }}"
        echo "Notify: ${{ needs.notify.result }}"
