name: Flutter CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

# ç¯å¢ƒå˜é‡
env:
  FLUTTER_VERSION: '3.27.4'
  CHANNEL: 'stable'

jobs:
  analyze:
    name: Code Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.CHANNEL }}
    
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          build
        key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          flutter-${{ env.FLUTTER_VERSION }}-
    
    - name: Install dependencies
      run: flutter pub get
      continue-on-error: true
    
    - name: Retry pub get
      if: steps.install-dependencies.outcome != 'success'
      run: |
        echo "Retrying pub get..."
        flutter pub get
    
    - name: Run flutter analyze
      run: flutter analyze
      continue-on-error: true

  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: analyze
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.CHANNEL }}
    
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          build
        key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          flutter-${{ env.FLUTTER_VERSION }}-
    
    - name: Install dependencies
      run: flutter pub get
      continue-on-error: true
    
    - name: Run tests
      run: flutter test --coverage
      continue-on-error: true

  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: test
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.CHANNEL }}
    
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          build
        key: flutter-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          flutter-${{ env.FLUTTER_VERSION }}-
    
    - name: Cache Gradle
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
        key: gradle-${{ runner.os }}-${{ hashFiles('**/build.gradle') }}
        restore-keys: |
          gradle-${{ runner.os }}-
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build APK
      run: flutter build apk --debug
      continue-on-error: true
    
    - name: Upload APK on success
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: app-debug.apk
        path: build/app/outputs/flutter-apk/app-debug.apk
        retention-days: 5
    
    - name: Upload error logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-error-logs
        path: |
          build/**/outputs/**/*.*/
          build/**/logs/**/*.*
        retention-days: 5

  build-windows:
    name: Build Windows
    runs-on: windows-latest
    needs: test
    timeout-minutes: 30
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: ${{ env.CHANNEL }}
    
    - name: Cache Flutter dependencies
      uses: actions/cache@v4
      with:
        path: |
          ${{ env.USERPROFILE }}/AppData/Local/Pub/Cache
          build
        key: flutter-win-${{ env.FLUTTER_VERSION }}-${{ hashFiles('**/pubspec.lock') }}
        restore-keys: |
          flutter-win-${{ env.FLUTTER_VERSION }}-
    
    - name: Install dependencies
      run: flutter pub get
    
    - name: Build Windows
      run: flutter build windows
      continue-on-error: true
    
    - name: Upload Windows artifact
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: xuelema-windows
        path: build/windows/runner/Release/
        retention-days: 5

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [analyze, test, build-android, build-windows]
    if: always()
    timeout-minutes: 10
    
    steps:
    - name: Collect results
      id: results
      run: |
        echo "analyze=${{ needs.analyze.result }}" >> $GITHUB_OUTPUT
        echo "test=${{ needs.test.result }}" >> $GITHUB_OUTPUT
        echo "android=${{ needs.build-android.result }}" >> $GITHUB_OUTPUT
        echo "windows=${{ needs.build-windows.result }}" >> $GITHUB_OUTPUT
        
        # Determine overall status
        if [ "${{ needs.analyze.result }}" == "success" ] && \
           [ "${{ needs.test.result }}" == "success" ] && \
           [ "${{ needs.build-android.result }}" == "success" ]; then
          echo "status=success" >> $GITHUB_OUTPUT
          echo "âœ… æ„å»ºæˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
        else
          echo "status=failure" >> $GITHUB_OUTPUT
          echo "âŒ éƒ¨åˆ†æ„å»ºå¤±è´¥ï¼Œè¯·æŸ¥çœ‹è¯¦æƒ…" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Generate summary
      if: always()
      run: |
        echo "## æ„å»ºç»“æœ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ” ä»£ç åˆ†æ | ${{ needs.analyze.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ§ª å•å…ƒæµ‹è¯• | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ¤– Android | ${{ needs.build-android.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸªŸ Windows | ${{ needs.build-windows.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“… ${{ github.run_id }} | ${{ github.sha }} | ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
    
    - name: Print final status
      run: |
        if [ "${{ steps.results.outputs.status }}" == "success" ]; then
          echo "ğŸ‰ All checks passed! æ„å»ºæˆåŠŸï¼"
        else
          echo "âš ï¸ Some checks failed. æŸ¥çœ‹ artifacts äº†è§£è¯¦æƒ…"
        fi
