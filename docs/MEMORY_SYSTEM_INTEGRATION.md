# 记忆系统集成设计方案

## 1. 当前架构分析

### 1.1 文件存储系统（正在使用）
```
memory/
├── YYYY-MM-DD.md              # 每日原始日志
├── DEVELOPMENT_LOG.md         # 开发日志
└── MEMORY.md                  # 长期记忆（主会话专用）
```

### 1.2 数据库模块（已开发，未集成）
```
.memory/
├── crud_api.py                 # SQLite 存储层
├── chromadb_storage.py         # 向量存储
├── core/                      # 核心表定义
├── conversations/             # 对话数据目录
├── knowledge/                 # 知识库目录
├── goals/                     # 目标管理目录
├── _index/                    # 索引和数据库文件
│   ├── memory.db             # SQLite 数据库
│   └── vector_db/            # 向量数据库
└── _archive/                  # 归档目录
```

### 1.3 问题分析
| 问题 | 影响 |
|------|------|
| 数据库模块完整但未集成 | 无法利用结构化存储 |
| 向量存储未使用 | 缺乏语义搜索能力 |
| 两套系统完全独立 | 数据冗余、维护困难 |
| 缺乏统一查询接口 | 检索效率低 |

---

## 2. 集成架构设计

### 2.1 目标架构
```
┌─────────────────────────────────────────────────────────────┐
│                     统一记忆 API 层                          │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐    │
│  │ save()      │  │ load()      │  │ search()        │    │
│  │ delete()    │  │ get()       │  │ query()         │    │
│  └─────────────┘  └─────────────┘  └─────────────────┘    │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     双写同步引擎                             │
│  ┌─────────────────────────────────────────────────────┐   │
│  │ 同时写入：                                            │   │
│  │   1. SQLite（结构化数据）                           │   │
│  │   2. 向量存储（语义搜索）                           │   │
│  │   3. .md 文件（备份/导出）                          │   │
│  └─────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
                              │
         ┌────────────────────┼────────────────────┐
         ▼                    ▼                    ▼
┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐
│  SQLite         │  │ 向量存储        │  │ 文件存储        │
│  (结构化数据)   │  │ (语义搜索)      │  │ (备份/导出)     │
└─────────────────┘  └─────────────────┘  └─────────────────┘
```

### 2.2 存储规则

| 数据类型 | 主存储 | 备份 | 索引方式 |
|----------|--------|------|----------|
| 每日对话 | SQLite | .md | 向量 + 标签 |
| 长期记忆 | SQLite | MEMORY.md | 向量 + 标签 |
| 开发日志 | .md | SQLite | 标签 |
| 重要决策 | SQLite | MEMORY.md | 向量 + 标签 |

### 2.3 写入时机

| 事件 | 触发操作 |
|------|----------|
| 新对话产生 | 保存到 SQLite + 向量 + .md |
| 重要决策 | 保存到 SQLite + 向量 + MEMORY.md |
| 每日总结 | 同步所有数据到 .md 文件 |
| 标签更新 | 更新 SQLite + 向量索引 |

---

## 3. 实现步骤

### 3.1 创建统一记忆 API（`memory_system/`）

```
memory_system/
├── __init__.py              # 统一导出
├── unified_api.py           # 统一接口层
├── dual_writer.py           # 双写引擎
├── file_sync.py             # 文件同步
└── config.py                # 配置管理
```

### 3.2 集成点

1. **集成到 OpenClaw 主会话**
   - 在启动时初始化统一记忆 API
   - 替换/包装现有的 memory_search/memory_get

2. **集成到日常流程**
   - 自动保存对话到数据库
   - 自动标签生成
   - 自动摘要提取

3. **集成到搜索功能**
   - 统一搜索接口（模糊 + 语义）
   - 标签过滤
   - 时间范围筛选

---

## 4. 迁移现有数据

### 4.1 迁移清单

| 数据 | 迁移方式 | 优先级 |
|------|----------|--------|
| MEMORY.md | 解析并导入 SQLite | P0 |
| memory/*.md | 批量导入 SQLite | P1 |
| 开发日志 | 保留 .md，导入关键数据 | P2 |

### 4.2 迁移脚本

```python
# migrate_from_files.py
import os
import json
from datetime import datetime
from memory_system import UnifiedMemory

def migrate_memory_md():
    """迁移 MEMORY.md"""
    with open('MEMORY.md', 'r', encoding='utf-8') as f:
        content = f.read()
    
    um = UnifiedMemory()
    um.save(
        key="longterm_memory",
        value=content,
        memory_type="knowledge",
        tags=["system", "memory", "migrated"]
    )

def migrate_daily_notes():
    """迁移每日笔记"""
    for file in os.listdir('memory/'):
        if file.endswith('.md'):
            date = file.replace('.md', '')
            # 解析并导入
```

---

## 5. 下一步行动

### Phase 1: 创建集成层
- [ ] 创建 `memory_system/` 目录
- [ ] 实现 `unified_api.py`
- [ ] 实现 `dual_writer.py`
- [ ] 实现 `file_sync.py`

### Phase 2: 集成到 OpenClaw
- [ ] 替换 memory_search/memory_get
- [ ] 添加自动保存钩子
- [ ] 添加标签系统集成

### Phase 3: 迁移现有数据
- [ ] 迁移 MEMORY.md
- [ ] 迁移 daily notes
- [ ] 验证数据完整性

---

## 6. 预计收益

| 指标 | 当前 | 集成后 |
|------|------|--------|
| 查询速度 | O(n) 扫描 | O(1) 索引 |
| 语义搜索 | 不支持 | 支持 |
| 数据结构 | 扁平文本 | 结构化存储 |
| 标签管理 | 手动 | 自动 + 检索 |

---

*设计时间：2026-02-20*
*状态：待实施*
