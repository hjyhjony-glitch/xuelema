# 团队自测系统设计方案

**项目**: OpenClaw 团队自测系统  
**版本**: v1.0  
**创建日期**: 2026-02-20  
**负责人**: RUNBOT-ARC（青岩）项目总监

---

## 1. 自测系统必要性分析

### 1.1 背景问题

当前开发流程存在以下风险：

| 问题 | 影响 | 频率 |
|------|------|------|
| 直接推送 GitHub 导致问题代码外泄 | 污染主分支、影响团队协作 | 高 |
| 缺少本地验证即提交 | 编译失败、运行错误 | 中高 |
| 团队成员职责不清 | 重复测试或遗漏测试 | 中 |
| 缺乏标准化流程 | 质量参差不齐 | 中 |

### 1.2 自测系统价值

```
┌─────────────────────────────────────────────────────────┐
│                    自测系统核心价值                      │
├─────────────────────────────────────────────────────────┤
│  ✓ 质量关口前移：在本地拦截问题                           │
│  ✓ 责任明确：ARC/DEV/ASS/RUNBOT 各司其职                 │
│  ✓ 流程可控：标准化检查清单确保覆盖全面                   │
│  ✓ 效率提升：自动化工具减少人工负担                       │
│  ✓ 代码安全：本地验证后再推送，避免污染远程仓库           │
└─────────────────────────────────────────────────────────┘
```

### 1.3 ROI 分析

- **投入**: 每次提交增加 5-15 分钟自测时间
- **收益**: 
  - 减少 70% 的主分支回滚操作
  - 节省问题定位和修复时间（每次问题约 1-2 小时）
  - 提升团队整体代码质量

---

## 2. 自测流程设计

### 2.1 整体流程图

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  本地开发   │───▶│  本地构建    │───▶│  团队自测   │───▶│  推送GitHub │
│  (Coding)   │    │  (Build)    │    │  (Self-Test)│    │  (Push)     │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                          │                  │                   │
                          ▼                  ▼                   ▼
                    [构建检查]         [功能测试]          [CI验证]
                    [依赖检查]         [兼容性测试]        [自动部署]
```

### 2.2 详细流程步骤

#### 阶段 1：本地开发完成 (开发者)

```
步骤 1.1: 完成代码编写和本地调试
步骤 1.2: 确保所有单元测试通过 (如果存在)
步骤 1.3: 运行代码格式化工具 (black/isort/ruff)
步骤 1.4: 更新 CHANGELOG.md 或相关文档
```

#### 阶段 2：本地构建 (所有成员)

```
步骤 2.1: 清理旧构建产物
    └─> 命令: ./scripts/clean_build.sh

步骤 2.2: 运行依赖检查
    └─> 命令: pip-compile --dry-run (Python) / npm ci --dry-run (Node.js)

步骤 2.3: 执行本地构建
    └─> 命令: ./scripts/build.sh [platform]

步骤 2.4: 验证构建产物存在且有效
    └─> 检查: 文件大小 > 0, 无编译错误
```

#### 阶段 3：团队自测 (根据角色)

```
┌────────────────────────────────────────────────────────────┐
│  ARC (架构师)                                              │
│  ├─ 架构合理性检查                                          │
│  ├─ 接口设计审查                                            │
│  ├─ 性能影响评估                                            │
│  └─ 安全漏洞扫描                                            │
├────────────────────────────────────────────────────────────┤
│  DEV (开发)                                                 │
│  ├─ 单元测试执行                                            │
│  ├─ 集成测试执行                                            │
│  ├─ 功能验证                                                │
│  └─ 回归测试 (影响范围分析)                                  │
├────────────────────────────────────────────────────────────┤
│  ASS (资产/美术)                                            │
│  ├─ 资源完整性检查                                          │
│  ├─ 格式兼容性验证                                          │
│  └─ 视觉效果验证                                            │
├────────────────────────────────────────────────────────────┤
│  RUNBOT (自动化)                                            │
│  ├─ 自动化测试套件执行                                      │
│  ├─ 端到端测试验证                                          │
│  ├─ 跨平台兼容性测试                                        │
│  └─ 性能基准测试                                            │
└────────────────────────────────────────────────────────────┘
```

#### 阶段 4：推送 GitHub (自测通过后)

```
步骤 4.1: 创建功能分支 (如果尚未创建)
    └─> git checkout -b feature/xxx

步骤 4.2: 提交更改
    └─> git add . && git commit -m "feat: xxx"

步骤 4.3: 推送到远程
    └─> git push origin feature/xxx

步骤 4.4: 创建 Pull Request (如需)
    └─> 标记自测通过，提供测试报告摘要
```

---

## 3. 自测标准与检查清单

### 3.1 必检项目 (Blocker Check)

**必须全部通过，否则禁止推送：**

| # | 检查项 | 标准 | 自动/手动 |
|---|--------|------|-----------|
| 1 | 语法检查 | 所有代码文件无语法错误 | 自动 |
| 2 | 构建成功 | 本地构建命令执行通过 | 自动 |
| 3 | 单元测试 | 通过率 ≥ 80% | 自动 |
| 4 | 类型检查 | 无新增类型错误 (如启用) | 自动 |
| 5 | 代码格式化 | 符合项目代码风格 | 自动 |

### 3.2 推荐检查项 (Quality Check)

**建议执行，发现问题应修复但可酌情通过：**

| # | 检查项 | 标准 | 自动/手动 |
|---|--------|------|-----------|
| 1 | 安全扫描 | 无高危漏洞 | 自动 |
| 2 | 性能基准 | 核心指标无显著下降 | 自动 |
| 3 | 依赖更新 | 无过时的安全关键依赖 | 自动 |
| 4 | 文档更新 | 重大改动有文档说明 | 手动 |
| 5 | 测试覆盖 | 关键路径有测试覆盖 | 自动 |

### 3.3 角色专项检查

#### ARC 专项检查清单

```
□ 模块边界清晰，无循环依赖
□ API 设计符合 RESTful/GraphQL 规范
□ 数据库 schema 变更合理
□ 缓存策略设计合理
□ 异步处理逻辑正确
□ 错误处理机制完善
```

#### DEV 专项检查清单

```
□ 代码符合 PEP8 / Airbnb Style Guide
□ 变量命名有意义，无 magic number
□ 注释清晰，关键逻辑有说明
□ 无硬编码配置，使用环境变量
□ Git commit message 规范
□ 无 debug 代码残留 (console.log/print 等)
```

#### ASS 专项检查清单

```
□ 资源文件大小在合理范围内
□ 图片/音频格式符合项目规范
□ 资源引用路径正确
□ 多语言资源完整性
□ UI/UX 组件一致性
```

#### RUNBOT 专项检查清单

```
□ 自动化测试通过率 100%
□ CI Pipeline 预期通过
□ 跨平台构建成功 (至少 1 个额外平台)
□ 无性能回归 (执行时间增幅 < 10%)
□ 无内存泄漏 (如适用)
```

### 3.4 检查结果分级

| 级别 | 含义 | 行动 |
|------|------|------|
| 🟢 **PASS** | 全部必检项通过 | 允许推送 |
| 🟡 **WARN** | 必检项通过，但有警告 | 记录后允许推送 |
| 🔴 **FAIL** | 任意必检项未通过 | **禁止推送**，必须修复 |

---

## 4. 工具需求

### 4.1 现有工具清单

| 类别 | 工具 | 用途 | 状态 |
|------|------|------|------|
| 构建 | CMake/Make | 跨平台构建 | 已集成 |
| 测试 | pytest/unittest | 单元测试 | 已集成 |
| 格式化 | black/ruff | 代码格式化 | 已集成 |
| 类型检查 | mypy/pyright | 类型检查 | 已集成 |
| CI/CD | GitHub Actions | 自动化流程 | 已集成 |

### 4.2 需要新增的工具

#### 4.2.1 核心工具

| 工具 | 功能 | 推荐方案 |
|------|------|----------|
| **自测入口脚本** | 一键执行所有自检项 | `./scripts/self_test.sh` |
| **测试报告生成器** | 生成 HTML/JSON 格式报告 | 自研 |
| **构建验证工具** | 检查构建产物有效性 | 自研 |
| **依赖扫描器** | 检测过时/漏洞依赖 | `safety` / `npm audit` |

#### 4.2.2 工具规格

**自测入口脚本 (`self_test.sh`)**

```bash
#!/bin/bash
# 用法: ./scripts/self_test.sh [options]
# Options:
#   --quick    快速模式 (仅必检项)
#   --full     完整模式 (全项检查)
#   --report   生成详细报告
#   --platform <win|mac|linux> 指定平台

set -e

# 颜色输出
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# 计数器
PASS=0
FAIL=0
WARN=0

run_check() {
    local name="$1"
    local command="$2"
    
    echo -n "Checking $name... "
    if eval "$command" > /dev/null 2>&1; then
        echo -e "${GREEN}PASS${NC}"
        ((PASS++))
        return 0
    else
        echo -e "${RED}FAIL${NC}"
        ((FAIL++))
        return 1
    fi
}

# 主流程
main() {
    echo "========================================"
    echo "OpenClaw Self-Test System v1.0"
    echo "========================================"
    
    # 必检项
    run_check "Syntax Check" "python -m py_compile src/main.py" || true
    run_check "Build Success" "./scripts/build.sh --quick" || true
    run_check "Unit Tests" "pytest tests/ -q" || true
    run_check "Code Format" "black --check src/" || true
    
    # 输出结果
    echo "========================================"
    echo "Result: $PASS PASSED, $FAIL FAILED, $WARN WARNINGS"
    echo "========================================"
    
    if [ $FAIL -gt 0 ]; then
        echo -e "${RED}自测未通过，禁止推送！${NC}"
        exit 1
    fi
    
    exit 0
}
```

### 4.3 工具集成计划

| 阶段 | 内容 | 优先级 |
|------|------|--------|
| **Phase 1** | 基础自测脚本 (必检项) | P0 |
| **Phase 2** | 测试报告生成 | P1 |
| **Phase 3** | 高级检查 (安全/性能) | P2 |
| **Phase 4** | IDE 插件集成 | P3 |
| **Phase 5** | CI 集成 (双保险) | P4 |

### 4.4 工具部署位置

```
OpenClaw_Workspace/
├── scripts/
│   ├── self_test.sh          # 自测入口
│   ├── clean_build.sh        # 清理构建
│   ├── build.sh              # 构建脚本
│   └── generate_report.sh    # 报告生成
├── tests/
│   ├── unit/                 # 单元测试
│   ├── integration/          # 集成测试
│   └── e2e/                  # 端到端测试
├── .github/
│   └── workflows/
│       └── self_test.yml     # GitHub Actions (可选)
└── docs/
    └── SELF_TEST_CHECKLIST.md  # 检查清单文档
```

---

## 5. 实施建议

### 5.1 渐进式推行

1. **Week 1-2**: 手动执行检查清单，记录问题
2. **Week 3-4**: 自动化工具开发完成，开始工具辅助
3. **Week 5+**: 全面自动化自测，强制执行

### 5.2 团队培训

- 编写《自测系统使用手册》
- 组织一次团队培训 (30 分钟)
- 建立答疑渠道 (飞书群/Slack)

### 5.3 持续改进

- 每月回顾自测数据，优化检查项
- 根据误报调整阈值
- 收集团队反馈，迭代流程

---

## 6. 附录

### 6.1 快速参考

```bash
# 执行快速自测
./scripts/self_test.sh --quick

# 执行完整自测并生成报告
./scripts/self_test.sh --full --report

# 仅运行测试
pytest tests/ -v

# 仅检查格式
black src/ --diff

# 仅检查类型
mypy src/
```

### 6.2 常见问题

**Q: 自测失败怎么办？**
A: 查看详细输出，修复问题后重新运行自测。

**Q: 紧急修复可以跳过自测吗？**
A: 可以，但需要在 PR Description 中说明原因，并安排后续补测。

**Q: Mac 和 Windows 结果不一致？**
A: 以 CI 结果为准，但本地应通过至少一个平台的测试。

### 6.3 变更记录

| 版本 | 日期 | 变更内容 | 作者 |
|------|------|----------|------|
| v1.0 | 2026-02-20 | 初始版本 | RUNBOT-ARC |

---

**文档结束**

*本方案由 RUNBOT-ARC（青岩）项目总监设计*
